- hosts: all
  become: true
  tasks:
    - name: Instalar iptables-persistent
      apt:
        name: iptables-persistent
        state: present
    
    - name: Crear reglas parala red de IT
      iptables:
        chain: INPUT
        protocol: tcp
        source:  "{{ IP }}"
        destination_port: "{{ ports }}"
        jump: ACCEPT
        when: "{{ type }}" == "dport"


    - name: Crear reglas parala red de IT
      iptables:
        chain: INPUT
        protocol: tcp
        source:  "{{ IP }}"
        destination_port: "{{ ports }}"
        jump: ACCEPT
        when: "{{ type }}" == "dports"

    - name: Permitir tráfico desde una IP a múltiples puertos TCP
      iptables:
        chain: INPUT
        protocol: tcp
        source: "IP_Autorizada"
        destination_port:
          - 22
          - 80
          - 443
        jump: ACCEPT
          when: "{{ type }}" == "dports"
        
        
    - name: Permitir tráfico relacionado/establecido
      iptables:
        chain: INPUT
        match: conntrack
        ctstate: RELATED,ESTABLISHED
        jump: ACCEPT

    - name: Permitir tráfico en interfaz de loopback
      iptables:
        chain: INPUT
        in_interface: lo
        jump: ACCEPT        

  
